// 1) This file doesn't have a .c extension so that the makefile for
// the native extension doesn't automatically compile it and include
// it in the final .so.

// 2) The .so file wasn't getting loaded dynamically with
// 'require', so I included the C source code directly.
#include "c_custom_to_s.c"


VALUE method_c_custom_to_s(VALUE self, VALUE first);
  
int main() {
  printf("The C program started\n");
  ruby_init();
  ruby_init_loadpath(); // without this the require and include don't work

  VALUE self;
  VALUE data_str_8 = rb_str_new_cstr("12345678");
  /* VALUE data_str_16 = rb_str_new_cstr("1234567890123456"); */

  int state;
  rb_eval_string_protect(
    "\n"
    "puts 'The VM started'\n"
    "filename = Dir.getwd + '/ccustomtos'\n"
    "p filename\n"
    "require filename\n"
    //"require Dir.getwd + '/ccustomtos'\n"
    "include CCustomToS\n"
    "data_str_8 = \"12345678\"\n"
    //"c_custom_to_s(data_str_8)\n"
    "puts 'The VM ended'\n"
    , &state);

  printf("rb_eval_string_protect ended\n");
  //VALUE ret = method_c_custom_to_s(self, data_str_8);

  int ret = ruby_cleanup(0);
  printf("The C program ended\n");
  return ret;
}
