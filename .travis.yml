language: ruby
dist: bionic
cache:
- bundle
- yarn

rbenv:
- 2.5
- 2.6
- 2.7
- 3.0
- 3.1

services:
- postgresql

before_install:
  - |
    sudo apt-get -y install ruby-dev \
      && (cd native_c_extension; ./build_in_specific_dir.sh ../lib/appmap) \
      && nvm install --lts \
      && nvm use --lts \
      && npm i -g yarn

before_deploy:
  - |
    npm i -g \
      semantic-release \
      @semantic-release/git \
      @semantic-release/changelog \
      semantic-release-rubygem

deploy:
  - provider: script
    script: ./release.sh
    on:
      branch: master
      condition: "$TRAVIS_RUBY_VERSION = 3.0"
